SQL> SET SERVEROUTPUT ON
SQL> DECLARE
  2  
  3  	 CURSOR C_INVERTIDO IS
  4  	     SELECT DISTINCT ID_DOCUMENTO, CUENTA
  5  	     FROM GELEC.ED_DET_DOCUMENTOS_CLIENTES
  6  	     WHERE FECHA_INICIO_CORTE>FECHA_FIN_CORTE
  7  	     AND CUENTA='3447906531'
  8  	     ORDER BY ID_DOCUMENTO, CUENTA
  9  	 ;
 10  
 11  	 CURSOR C_GELEC (P_CTA VARCHAR2, P_DOC VARCHAR2) IS
 12  	     SELECT ID_DOC_CLIENTE, FECHA_INICIO_CORTE, FECHA_FIN_CORTE, LOG_HASTA
 13  	     FROM GELEC.ED_DET_DOCUMENTOS_CLIENTES
 14  	     WHERE CUENTA=P_CTA AND ID_DOCUMENTO=P_DOC
 15  	     ORDER BY ID_DOC_CLIENTE
 16  	 ;
 17  
 18  	 CURSOR C_OMS (P_CTA VARCHAR2, P_DOC VARCHAR2) IS
 19  	     SELECT
 20  		 c.cuenta,
 21  		 substr(l.linkvalue,0,instr(l.linkvalue,'-')-1) CT,
 22  		 AE.ID ID_AFECTACION,
 23  		 aro.document_id,
 24  		 ARO.TIME FECHA_INICIO,
 25  		 (select a.time from nexus_gis.oms_affect_restore_operation a, nexus_gis.oms_affected_element b where a.id=b.restore_id and b.id=ae.id) Fecha_Restauracion
 26  		 , ROW_NUMBER() OVER (ORDER BY aro.time) AS num_fila
 27  	     FROM
 28  		 NEXUS_GIS.SPRLINKS L,
 29  		 NEXUS_GIS.SPROBJECTS O,
 30  		 NEXUS_GIS.OMS_AFFECTED_ELEMENT AE,
 31  		 NEXUS_GIS.OMS_AFFECT_RESTORE_OPERATION ARO,
 32  		 gelec.ed_clientes c
 33  	     WHERE
 34  		 L.LOGIDTO=0
 35  		 AND L.LINKID=1018
 36  		 AND L.OBJECTID=O.OBJECTID
 37  		 AND O.LOGIDTO=0
 38  		 AND O.OBJECTNAMEID=AE.ELEMENT_ID
 39  		 AND AE.AFFECT_ID=ARO.ID
 40  		 AND ARO.IS_RESTORE=0
 41  		 AND ARO.OPERATION_ID IS NOT NULL
 42  		 AND SUBSTR(L.LINKVALUE,0,INSTR(L.LINKVALUE,'-')-1)=C.CT
 43  		 AND ARO.DOCUMENT_ID=P_DOC
 44  		 AND C.CUENTA=P_CTA
 45  	     ORDER BY
 46  		 ARO.TIME ASC
 47  	     ;
 48  
 49  	 V_FILA NUMBER;
 50  	 V_MATCH BOOLEAN;
 51  	 V_NOTA VARCHAR(300);
 52  	 V_ID NUMBER;
 53  
 54  	 P_ID_NOTA VARCHAR(100);
 55  	 P_LOG_DESDE VARCHAR(100);
 56  
 57  BEGIN
 58  	 --RECORRO AFECTACIONES CON FECHA INICIO SUPERIOR A FIN
 59  	 FOR F_INVERTIDO IN C_INVERTIDO LOOP
 60  	     DBMS_OUTPUT.PUT_LINE(F_INVERTIDO.CUENTA);
 61  	     DBMS_OUTPUT.PUT_LINE(F_INVERTIDO.ID_DOCUMENTO);
 62  	     V_FILA:=0;
 63  	     --OBTENGO TODAS LAS AFECTACIONES, NO SOLO LAS ERRONEAS
 64  	     FOR F_GELEC IN C_GELEC(F_INVERTIDO.CUENTA, F_INVERTIDO.ID_DOCUMENTO) LOOP
 65  		 V_MATCH:=FALSE;
 66  		 V_FILA:= V_FILA+1;
 67  		 V_ID:= F_GELEC.ID_DOC_CLIENTE;
 68  		 DBMS_OUTPUT.PUT_LINE('AFECTACION #'||V_FILA);
 69  		 DBMS_OUTPUT.PUT_LINE('ID_DOC_CLIENTE: '||V_ID);
 70  		 --OBTENGO LAS FECHA CORRECTAS EN TODAS LAS AFECTACIONES
 71  		 FOR F_OMS IN C_OMS(F_INVERTIDO.CUENTA, F_INVERTIDO.ID_DOCUMENTO) LOOP
 72  		     IF F_OMS.NUM_FILA=V_FILA THEN
 73  			 V_MATCH:=TRUE;
 74  			 V_NOTA:=' INICIO: '||F_GELEC.FECHA_INICIO_CORTE||' POR '||F_OMS.FECHA_INICIO||' FIN: '||F_GELEC.FECHA_FIN_CORTE||' POR '||F_OMS.FECHA_RESTAURACION;
 75  			 DBMS_OUTPUT.PUT_LINE(V_NOTA);
 76  		     END IF;
 77  		 END LOOP;
 78  		 --PREGUNTO SI HUVO MATCH
 79  		 IF V_MATCH=TRUE THEN
 80  		     --ACTUALIZO POR LAS FECHAS CORRECTAS DE OMS
 81  		     DBMS_OUTPUT.PUT_LINE('Corresponde actualizar!');
 82  		     UPDATE GELEC.ED_DET_DOCUMENTOS_CLIENTES
 83  		     SET
 84  			 FECHA_INICIO_CORTE= F_OMS.FECHA_INICIO,
 85  			 FECHA_FIN_CORTE= F_OMS.FECHA_RESTAURACION
 86  		     WHERE
 87  			 ID_DOC_CLIENTE= F_GELEC.ID_DOC_CLIENTE
 88  		     ;
 89  		 ELSE
 90  		     --ACTUALIZO POR LAS FECHAS CORRECTAS DE OMS
 91  		     DBMS_OUTPUT.PUT_LINE('Corresponde anular!');
 92  		     V_NOTA:=' '||F_GELEC.FECHA_FIN_CORTE||' POR '||F_GELEC.FECHA_INICIO_CORTE;
 93  		     UPDATE GELEC.ED_DET_DOCUMENTOS_CLIENTES
 94  		     SET
 95  			 FECHA_FIN_CORTE= FECHA_INICIO_CORTE
 96  		     WHERE
 97  			 ID_DOC_CLIENTE= F_GELEC.ID_DOC_CLIENTE
 98  		     ;
 99  		 END IF;
100  		 --INSERTO NOTA
101  		 GELEC.PKG_NOTAS.INSERTAR_NOTA (
102  		     P_USER_ID => 'BATCH',
103  		     P_NOTA => 'Se actualizo afectacion #'||C_GELEC.ID_DOC_CLIENTE||' '||V_NOTA,
104  		     P_ID_DESTINO => NULL,
105  		     P_EFECTIVO => NULL,
106  		     P_ID_TIPO_NOTA => 1,
107  		     P_ID_SUBTIPO_NOTA => 4,
108  		     P_ID_FECHA_ALERTA => NULL,
109  		     P_DESCRIPCION_LOG => 'Modifica Fecha de Afectacion: ',
110  		     P_ORIGEN => 'BATCH',
111  		     P_ID_NOTA => P_ID_NOTA,
112  		     P_LOG_DESDE => P_LOG_DESDE
113  		 ) ;
114  		 DBMS_OUTPUT.PUT_LINE(
115  		     'Insertamos nota>>'||
116  		     ' ID_NOTA: '||P_ID_NOTA||
117  		     ' LOG_DESDE: '||P_LOG_DESDE
118  		 );
119  	     END LOOP;
120  	     DBMS_OUTPUT.PUT_LINE('-------------------------------------------------------------------------');
121  	 END LOOP;
122  
123  	 COMMIT;
124  
125  END;
126  
127  
128  
129  
130  
131  
132  show errors;
133  
134  exit
135  
136  
